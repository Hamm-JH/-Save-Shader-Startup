# 3장 그래픽스 파이프라인



- 3장에선 그래픽스 파이프라인의 후킹을 포함한 셰이더의 실행과정을 묘사한다.



- 초기의 3D 렌더러들은 완벽히 소프트웨어적으로 구현됐지만 느렸다.
- 3D 가속개념 등장으로 렌더링 과정을 하드웨어로 대체
- 탄력성이 떨어짐에 따라 일부 프로그래밍 가능한 셰이더로 대체됨
- 셰이더가 그래픽스 파이프라인에서 어떠한 단계에 해당하는지 본다.



## 그래픽스 API 기본을 배워야 하는 이유



OpenGL, Metal, Vulkan, Direct3D등의 그래픽스 API는 각기 다른 플랫폼을 기반으로 제작되었다. 그렇지만 하드웨어 가속의 이점을 취하기 위한 목적은 동일하다.

소프트웨어 렌더러를 밑바닥부터 작성하는것은 분명 가능하지만 교육적으로 좋은 경험이 될수 있지 효율적인 작업은 아니다. 그래픽스API를 직접 사용하지 않고도 이를 감싼 게임엔진이 이를 사용할수 있도록 엔진이 만들어져있기 때문이다.

일반적으로 게임엔진 개발자가 아니라면 그래픽스 API를 직접적으로 다루기를 원치 않는다.

하지만 이는 매유 유용하다. 셰이더를 개발할 때와 같이 때에 따라서는 밑바닥에서 무슨 일이 벌어지는지 아는것이 반드시 필요하다.
그래픽스 파이프라인과 그래픽스 API의 존재를 인지하지 못한 경우 셰이더 최적화에 어려움을 겪기 때문이다.



## 그래픽스 파이프라인의 일반적인 구조



- 그래픽스 API마다 다른 부분이 존재할수 있지만 일반적인 순서는 다음과 같다.

1. 정점 지정
   - 입력 조립 단계는 씬으로부터 데이터(메시, 텍스처, 재질)를 수집하고 파이프라인에서 사용할 수 있게 정리
2. 정점 셰이더
   - 정점 처리 단계에서는 정점과 정점의 정보를 이전 단계로부터 전달받아 각각의 정점에 정점 셰이더를 수행한다.
3. 정점 후처리
   - 정점 후처리 단계에서는 좌표 공간 변환 및 화면(screen)을 넘어서지 않게끔 기본형(primitive)들을 절단한다.
4. 기본형 조립
   - 기본형 조립 단계는 각 기본형마다 정점 처리 단계의 출력 데이터를 수집해 다음 
5. 레스터라이저
   - 레스터라이저는 프로그래밍 가능한 단계가 아니다. 이 단계에서는 입력 데이터로 삼각형(3개의 정점과 그것들의 데이터)을 받는다. 그리고 후보 픽셀(프레그먼트)들을 생성한다. 또한 각각의 프레그먼트를 위한 보간된 정점관련 속성 데이터와 깊이 값을 생성한다.
6. 프레그먼트 셰이더
   - 프레그먼트 셰이더 단계에서는 레스터라이저가 생성한 모든 프레그먼트마다 프레그먼트 셰이더를 실행한다. 픽셀의 색상을 계산하기 위해 여러가지 프레그먼트가 필요할 수도 있다.(예. 안티얼라이싱)
7. 샘플별 연산
   - 출력 병합자(output merger)는 가시성 테스트를 수행해 프레그먼트가 앞에 있는 다른 프레그먼트 위에 덮어 씌워질지 결정한다. 또한 투명성에 필요한 블렌딩과 같은 다른 여러가지 테스트를 수행한다.



## 레스터라이저



- 레스터라이저는 렌더링 파이프라인에서 중요한 부분이다.
- 최종 이미지에서 삼각형이 차지하는 픽셀이 무엇인지 결정한다.
  - 레스터라이저는 또한 삼각형이 차지하는 픽셀 위에 각 정점에 해당하는 다른 값들(색상값이나 UV 및 노멀 ㄱ밧과 같은)을 보간한다.

- 레스터라이저는 숨겨진 기능이라 간과하기 쉽다.
  - 레스터라이저의 주요기능중 하나는 정점 색상의 보간이다.



## 언릿 셰이더의 구조



- 언릿 셰이더에는 두 가지의 셰이더 함수가 존재한다.
- 언릿 셰이더에는 정보 전달을 위한 두 가지의 데이터 구조체를 사용한다.
  - 이는 그래픽스 파이프라인의 일부를 스크립트화하는 것이다.
- **위의 과정을 이해하기 위해 좀더 자세히 알아보자**



정점 셰이더는  <span style="color:blue">**appdata 구조체**</span>를 통해 수집하고 이는 정점 함수로 전달된다.
정점 함수는 <span style="color:#0000ff"><u>**v2f(vertex to fragment의 약자)**</u></span> 데이터 구조 멤버들의 내용을 채우고 이를 프레그먼트 함수의 인자로 전달한다.

- 데이터 구조 멤버들의 내용을 채우고 이를 프레그먼트 함수의 인자로 전달한다.

프레그먼트 함수는 최종 색상을 반환하는데 이 값은 4가지(빨강, 녹색, 파랑, 알파) 값을 갖는 하나의 정점이다.



### 언릿 셰이더 흐름

1. 사물데이터
2. appdata 구조체
3. 정점 셰이더
4. v2f 구조체
5. 프레그먼트 셰이더
6. 최종 색상



이후 내용은 셰이더 파일에서 설명

