# 5장 최초 라이팅 셰이더

- 이 책의 주제인 라이팅에 대해서 다룬다.
- 셰이더를 작성하는 방법은 다양함
  - 심지어 라이팅을 고려하지 않아도 가능함
  - 하지만 핵심은 라이팅 계산
    - 화려하고 개성있는 게임을 만드는데 도움을 줌
- MonochromeShader를 가지고 근사 라이팅 계산을 한다.
  - 이는 물리 기반 렌더링 이전에 사용함
  - 값싸고 단순하나, 보기에는 좋지 않음
    - 전형적인 옛날 비디오 게임처럼 보일수 있다.
    - 셰이더의 변천사를 이해하는데 도움을 받을수 있다.

- 이 책의 주제인 라이팅에 대해서 다룬다.
- 셰이더를 작성하는 방법은 다양함
  - 심지어 라이팅을 고려하지 않아도 가능함
  - 하지만 핵심은 라이팅 계산
    - 화려하고 개성있는 게임을 만드는데 도움을 줌
- MonochromeShader를 가지고 근사 라이팅 계산을 한다.
  - 이는 물리 기반 렌더링 이전에 사용함
  - 값싸고 단순하나, 보기에는 좋지 않음
    - 전형적인 옛날 비디오 게임처럼 보일수 있다.
    - 셰이더의 변천사를 이해하는데 도움을 받을수 있다.



[라이팅 셰이더](#라이팅-셰이더)

​	[근사란?](#근사란)

​	[디퓨즈 근사](#디퓨즈-근사)

​	[스펙큘러 근사](#스펙큘러-근사)

​	[디퓨즈와 스펙큘러의 조합](#디퓨즈와-스펙큘러의-조합)

​	[기본 라이팅 계산](#기본-라이팅-계산)

​	[최초 유니티 라이팅 셰이더](#최초-유니티-라이팅-셰이더)

---

## 라이팅 셰이더



- 빛이 표면에 부빚히는 과정을 시뮬레이션하는데 필요한 모든 계산이 들어있음.
- 대부분의 라이팅 셰이더는 렌더링 방정식을 기반으로함
- 영화 렌더링 커뮤니티에서 비롯된 물리 기반 모델이 퍼짐

- 라이팅 계산의 다른 부분을 지칭하는데 사용한 몇 가지 용어들



| 용어              | 설명                                                         |
| ----------------- | ------------------------------------------------------------ |
| 디퓨즈 Diffuse    | 불규칙한 미세면을 가진 표면의 부분집합<br />다양한 방향으로 빛을 반사함. |
| 스펙큘러 Specular | 정렬된 미세면을 가진 표면의 부분집합<br />비슷한 방향으로 빛을 반사함. |
| 엠비언트 Ambient  | 씬 안에서의 최소 빛의 강도다.<br />따라서 빛이 전혀 도달하지 않는 곳이라 해도<br />단순 검정색이 되지 않게 한다. |



### 근사란?

- 근사(Approximation) : 값이나 수량이 거의 가깝지만 정확한 것이 아님.
- 여기서 근사의 의미
  - 렌더링 방정식의 일부분을 계산하는 대안을 의미
  - 실시간 렌더링 방정식의 연산을 수행하는 것은 적분때문에 어려운 편



<p align="center">
    <img src="./Images/Chap5/5장 근사 공식.png"/>
</p>

- 위의 수식은 적분기호 뒤의 계산 그룹을 x라는 표면을 덮는 반구 안에 있는 각각의 w 방향마다 반복해야 함을 의미한다.
  - 각 방향이라는 말은 엄청난 가짓수의 방향이라는 것을 의미함
  - GPU 기반으로 구현한 실시간 레이캐스팅 같은 것들이 등장함에도 이 적분들 실시간 계산하는것은 상상이 힘듬



- 값싼 근사로 60fps 가능하다.
  - 렌더링의 사실성을 일부 포기함을 의미함.
  - 게임에서 극한의 사실성이 무조건 필요하진 않음.
  - 이 책에서 물리 기반 렌더링의 척도 확인을 위해 이 사실성에 초점을 맞춘다.



---

## 디퓨즈 근사



(이미지)



- 이 근사는 오직 방향, 색상, 빛의 강도만 신경쓴다.
  - 미세 표면에 대해서 신경쓰지 않음.
- 목적
  - 렌더링된 모델의 각 픽셀이 얼마나 많은 빛이 쬐고 반사되는지 결정
  - 자세한 구현에 진입하지 않음
- 입력 (전달값)
  - 표면의 불투명 색상(unlit color)
  - 빛의 강도
  - 색상
  - 방향
- 출력
  - 최종 이미지에서의 그 지점의 색상



- 정점 셰이더로 구현 가능하다.
  - 픽셀보다 정점이 부하가 적어 성능을 높일수 있다.
  - 정상동작처럼 보이는 이유 : 레스터라이저가 값을 보간함.
    - 단점 : 인위적으로 보임



---

## 스펙큘러 근사



(이미지)



- 빛이 오직 몇 가지 방향으로만 반사된다는 사실은 스펙큘러가 시야에 의존적임을 뜻함
- 시점이 움직이면 - 스펙큘러 조건이 변하게 된다.
- 스펙큘러는 라이트맵을 통해 시뮬레이션이 힘듬
  - 라이트 맵에 방향, 다른 정보를 추가해서 구워야 하기 때문.



---

## 디퓨즈와 스펙큘러의 조합



(이미지)



- 디퓨즈, 스펙큘러라는 용어는 동일한 표면에 대부분 동시에 나타날 것이다.

- 금속 재질은 디퓨즈 적고 스펙큘러 요소 많지만 그래도 여전히 디퓨즈 요소 존재한다.
  - 이 둘을 조합한 라이팅 계산도는 위와 같다.



---

## 기본 라이팅 계산

위에서 디퓨즈와 스펙큘러 근사치를 정의했다. 이를 구현해본다.



### 디퓨즈



(이미지)



입사각 : 빛이 표면에 들어가는 각도

입사각이 **<u>크다</u>** - 표면에서 광선으로부터 **<u>적은</u>** 양의 빛을 받음
- 입사각 - 빛의 양 반비례 관계

표면이 받을 밝기 / 빛의 크기 계산

- 코사인 입사각을 사용

셰이더에서 라이팅을 계산하려면

- 표면의 노멀 벡터와 빛 벡터 각도를 계산해야함.

벡터는 숫자 값만을 의미하지 않음.

- 셰이더 언어에서 벡터는 2~4가지 원소를 가질수 있다.



여기서 필요한 연산 : 내적(dot product)

코사인과 내적 함수 모두 모든 셰이더 언어에서 지원한다.



- 밝기를 계산하는 두 가지 방법

```c#
float brightness = cos(angle_of_incidence); // 입사각으로 구하는 밝기
float brightness = dot(normal, lightDir);// 노멀 벡터와 빛의 방향 벡터로 계산한 밝기
float3 pixelColor = brightness * lightColor * surfaceColor; // 최종 표면 색상값
```

표면 색상과 빛의 색상을 곱한 이 연산결과는 조잡하지만 효과적인 빛의 근사치를 나타낼것이다.

이를 람버트(Lambert) 혹은 람버트 반사율(Lambertian Relectance)이라고 한다.



## 최초 유니티 라이팅 셰이더



### 디퓨즈 항 구현하기

<p align="center">
    <img src="./Images/Chap5/5장 DiffuseShader 람버트 디퓨즈 오리.png"/>
</p>

- 정점 셰이더에서 받은 값을 프레그먼트 셰이더에서 음영처리하는 과정
  - 코드 : DiffuseShader 참조



### 텍스처 속성 추가

<p align="center">
    <img src="./Images/Chap5/5장 DiffuseShader2 텍스처 입힌 오리.png"/>
</p>

- 작성한 셰이더에 오리 텍스처를 입히는 과정
  - 코드 : DiffuseShader2 참조



### 엠비언트 값 추가

<p align="center">
    <img src="./Images/Chap5/5장 DiffuseShader3 엠비언트 슬라이더 추가함.png"/>
</p>

- 엠비언트 값 조정하는 슬라이더 추가
  - 코드 DiffuseShader3 참조



