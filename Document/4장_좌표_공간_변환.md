# 4장 좌표 공간 변환



- 4장에서는 좌표 공간에 대해서 자세히 다룰 것이다. 그리고 각각의 좌표 공간이 그래픽스 파이프라인의 어느 부분에서 사용하는지 연결지어 본다.



[TOC]



---



- 이론적으로 각각의 계산에 어떤 좌표 공간을 사용할지 선택 가능

- 실시간 렌더링의 경우 이런 선택 대부분 컴퓨터 그래픽스 파이프라인에서 결정남
- 그래픽스 파이프라인에선 값들(정점, 노멀 등)이 처리 특정 단계에 특정 좌표 공간에 있을거라고 가정함
  - 이중 한 예) 이전 장에서 정점 셰이더가 정점의 위치를 출력할 때.
  - 정점의 출력 -> 절단 공간이라고 가정
    - v2f 데이터 구조체의 정점에 UnityObjectToClipPos(v.vertex) 설정했다.



---

## 좌표 공간 : 누가 누구인가?



- 실시간 렌더링에서 자주 사용하는 좌표 공간을 알아본다.
- 여기서 다룰 여섯 가지 좌표 공간
  - 객체 공간 Object Space
  - 월드 공간 World Space
  - 카메라 공간 Camera Space
  - 절단 공간 Clip space
  - 정규 스페이스 좌표 Normalized Device Coordinates
  - 스크린 공간 Screen Space



---

## 객체 공간 Object Space



- 객체 공간 : 3D 좌표체계
- 원점 : 렌더링 파이프라인으로 보낼 메시(mesh) 아래쪽이나 중앙으로 잡힘.
  - 주로 메시를 제작하는데 사용한 3D 모델링 소프트웨어의 중심점으로 잡힐 확률 큼

![4장 객체 공간](.\Images\Chap4\4장 객체 공간.png)

- 원점 위치 주목
- 로컬 공간 (Local Space) 또는 모델 공간(Model Space)로도 부름.
  - etc) 마야의 경우 다른 의미로 부르기도 함. 주의필요

- appdata에 정점 위치를 저장해 셰이더에 저장할 때
  - 정점의 위치는 객체공간 기준



---

## 월드 공간 World Space



- 참조기준 : 전체 씬 (하나의 메시기준 아님)

![4장 월드 공간](.\Images\Chap4\4장 월드 공간.png)

- 원점이 월드 공간에 정확히 위치하는 곳은 씬 배치에 따라 다르게 나타난다.
- 유니티에선 씬이 존재하는 공간을 의미함
  - 게임 오브젝트에서 사용하는 좌표를 공간 좌표로 변환해야 함



### 공간과 공간 간의 변환



- 각기 다른 좌표 공간을 변환하는 경우
  - 행렬 곱 사용
- 행렬의 편의성
  - 행렬 구성 가능하다
  - 어떤 행렬은 객체 공간에서 절단 공간 변환 가능



- 유니티는 어떤 값의 타입을 변환하는데 자주 사용하는 내장 함수를 다수 포함
  - 위치, 노멀, 빛의 방향 등
- 월드 공간에서 특정한 값을 얻을 수 있는 함수들

| 함수명                                             | 설명                                                         |
| -------------------------------------------------- | ------------------------------------------------------------ |
| float3 UnityObjectToWorldDir(in float3 dir)        | 객체 공간의 방향을 취해<br />월드 공간에서의 방향 값으로 변환 |
| float3 UnityObjectToWorldNormal(in float3 norm)    | 객체 공간의 노멀을 취해<br />월드 공간에서의 노멀 값으로 변환해준다.<br />빛을 계산하는데 유용함 |
| float3 UnityWorldSpaceViewDir(in float3 worldPos)  | 월드 공간에서의 정점 위치를 취해<br />월드 공간에서의 뷰의 방향을 반환한다.<br />빛을 계산하는 데 유용함 |
| float3 UnityWorldSpaceLightDir(in float3 worldPos) | 월드 공간에서의 정점 위치를 취해<br />월드 공간에서의 빛의 방향을 반환한다.<br />빛을 계산하는 데 유용함 |



- 이 함수들의 상세구현을 숨겨져 있음.
  - 단지 올바르게 사용하고 적용됐는지 확인만 하면됨
- 좌표 공간을 다른 좌표 공간으로 변환시 특정 행렬 사용함.
  - 유틸 함수 사용시 고민을 덜하면서 행렬 연산 수행가능
- 좌표 공간 사이 변환에 사용할 수 있는 다양한 삼수들은
  - UnityShaderVariables.cginc
  - UnityShaderUtilities.cginc
  - UnityCG.cginc
  - 위의 파일들에서 찾을수 있음.



- 행렬 직접 사용으로 실질적인걸 얻을수도 있음.
  - 이 경우 유니티에서 공간 변환에 사용가능한 내장 행렬을 포함하고 있음.
  - OpenGL 등과 동일한 옵션. 하지만, 행렬의 이름 다름.

- 객체 공간에서의 변환을 위한 몇 가지 내장 유니티 행렬

| 함수명              | 설명                                                         |
| ------------------- | ------------------------------------------------------------ |
| unity_ObjectToWorld | 객체 공간에서 월드 공간으로 변환하는 행렬                    |
| unity_WorldToObject | 위의 행렬의 역행렬, 월드 공간에서 객체 공간으로 변환하는 행렬 |

- 예) 객체 공간상의 정점의 위치를 월드 공간 기준으로 변형

`float4 vertexWorld = mul(unity_ObjectToWorld, v.vertex);`

- mul 함수에 행렬과 변환하고자 하는 값을 전달.
- 내장 행렬에 본인이 원하는 행렬이 존재하지 않으면 자신만의 행렬을 구성할수 있음.



---

## 카메라 공간 Camera Space



- 시야 공간(Eye Space) 혹은 뷰 공간(View Space)라고도 함.
- 월드 공간 좌표 체계와 동일한 씬을 담는다.
  - But, 렌더링의 시발점인 카메라의 시점으로 씬을 담음.

![4장 카메라 공간](.\Images\Chap4\4장 카메라 공간.PNG)



- 카메라 공간이 필요한 이유
  - 절단 공간을 출력하는데 필요한 단계
    - But, 이 단계의 대부분은 표준 셰이더 하부구조(infrastructure)에서 담당함.
- 카메라 공간에 사용하는 몇 가지 내장 행렬이 존재함.

| 함수명              | 설명                                                      |
| ------------------- | --------------------------------------------------------- |
| unity_WorldToCamera | 월드 공간에서 카메라 공간으로 변환한다.                   |
| unity_CameraToWorld | 위 행렬의 역행렬.<br />카메라 공간에서 월드 공간으로 변환 |

- 또한 하나의 내장함수 존재.

| 함수명                                    | 설명                                  |
| ----------------------------------------- | ------------------------------------- |
| float4 UnityViewToClipPos( in float3 pos) | 뷰 공간에서 절단 공간으로 위치를 변환 |



---

## 절단 공간 Clip space



- 렌더링 파이프라인의 정점 후처리 단계에는 절단(clipping)을 포함한다.
  - 공간의 경계에 조금이라도 속해있지 않는 기본 요소를 제거함.
- 절단 공간의 좌표 범위
  - -1 ~ 1
- 비 직관적인 요소 존재함
  - 지금까지 소개한 좌표 공간은 3개의 좌표축(x, y, z)을 사용하지 않음
  - 모두 4개의 좌표 공간을 가짐(x, y, z, w)
- w 좌표는 무엇인가?
  - 3D 렌더링에 카테시안 공간 그대로 사용시 문제발생
  - 두 평행선 서로 만날수 없어 원근법 표현이 불가능함
    - 문제 해결위해 좌표 하나 추가한데 이 좌표임
  - 이를 동차 좌표(homogeneous coordinates)라고 함
- w 좌표의 사용
  - ★ 적당한 시기(절단 공간에서 정규 기기 좌표로 가는 단계)에 w 값으로 다른 값은 보두 나눈다.
    - 이 과정으로 원근법 표현
    - 따라서 객체, 월드, 뷰, 절단 공간 - 4차원 좌표 사용해 표현
  - 절단 공간 제외하고 w는 1 값 가짐
- 뷰 공간에서 절단 공간으로 변환
  - 이 변환 연산으로 w값은 1이 아닌 다른 수로 변환
    - 변환된 행렬은 OpenGL에서는 투영 행렬(Projection matrix)라고 부름
  - w 값을 통해 정점을 잘라낼지 결정함.
  - 투영 행렬 설정 위해 시야부피(절경 : frustum)와 관련된 정보 필요.



- 어떤 종류의 투영법을 사용할지에 따라 이 절경은 변함
  - 일반적으로 사용하는 투영법
    - 원근 투영(perspective projection)
    - 정사영(orthographic projection)
- 원근 투영에서의 절경
  - 근평면 (a near plane)
  - 원평면(a far plane)
  - 으로 구성됨.
  - 원근법에선 멀리 떨어진 객체가 더 작게 보여야 함.
    - 크기 : 근평면 < 원평면
  - 시야각(The filed of view) : FOV
    - 근평면과 원평면의 비율을 정의함

![4장 원근법 절경](.\Images\Chap4\4장 원근법 절경.png)

- 시야범위 밖의 객체는 렌더링에서 빼버림(Discarded)



- 절단 공간에 활용하는 내장 행렬은 존재하지 않는다. 다만 몇 가지 내장 함수들이 존재함.

| 함수명                                     | 설명                                         |
| ------------------------------------------ | -------------------------------------------- |
| float4 UnityWorldToClipPos(in float3 pos)  | 위치를 월드 공간에서 절단 공간으로 변환      |
| float4 UnityViewToClipPos(in float3 pos)   | 위치를 뷰 공간에서 절단 공간으로 변환        |
| float4 UnityObjectToClipPos(in float3 pos) | 정점 위치를 객체 공간에서 절단 공간으로 변환 |



---

## 정규 기기 좌표 Normalized Device Coordinates, NDC



- 2D 공간
- 특정 스크린이나 이미지 해상도에 의존적이지 않음.
- NDC 기준 좌표
  - 절단 좌표를 w로 나눠서 얻음.
    - 원근 분할(perspective division)이라고 부름
  - OpenGL에서의 NDC 좌표
    - -1 ~ 1 값 범위
  - NDC는 두 가지 숫자가 아닌 세 가지 숫자를 사용.
    - 이 경우 z값은 동차 좌표보다 깊이 버퍼를 위한 것임.



---

## 화면 공간 Screen Space



- **화면버퍼** or **분할 렌더 타깃** or **하나의 이미지** 도 가능하다.
  - NDC를 뷰포트(viewport) 해상도로 확대,축소하고 변환해서 얻을수 있다.
  - 최종 화면 좌표가 레스터라이저로 전달된다.
  - 레스터라이저는 이걸로 프레그먼트를 생성한다.

![4장 화면 공간](.\Images\Chap4\4장 화면 공간.png)

- 화면 공간에서의 씬



### 내장 함수가 내포하는 것들

- 이전 장에서 사용했던 함수를 예시로 어떻게 동작하는지 자세하게 살펴보자

```c++
v2f vert (appdata v)
{
    v2f o;
    o.vertex = UnityObjectToClipPos(v.vertex);
    o.color = v.color;
    return o;
}
```

- UnityObjectToClipPos는 mul(UNITY_MATRIX_MVP, *)을 의미하는 함수
  - 객체 공간 -> 전달 공간으로 가는 행렬 곱셈.
  - 행렬은 일반적으로 행렬끼리 곱해 조합함.
  - 여기서는 Model Matrix * View matrix * Projection Matrix를 의미함.
    - 이 한줄로 한 번에
      객체 공간에서 -> 월드 공간과 -> 뷰 공간을 지나 -> 절단 공간 좌표에 도달한 것.



---

## 셰이더 "표준 라이브러리" 코드 위치



- 이 책에서 의도한 표준 라이브러리는 유니티 웹사이트에서 다운받을 수 있는 ZIP 파일을 의미함.
- 이 ZIP 파일은 유니티의 모든 셰이더 include 파일들과 셰이더 코드들이 들어있음.
  - 이 코드는 위치가 변할수도 있음.
- 이 코드 얻으려면 유니티 웹사이트에 들어가 이전 버전의 유니티를 바운받을 수 있는 링크를 찾는다.
- 거기에 유니티 버전들의 목록과 함께 각기 다른 다운로드 옵션들이 나온다.
- 찾아야 할 것은 내장 셰이더(Cuilt in Shaders) 옵션
- 이 링크를 클릭하면 모든 것들이 들어있는 ZIP 파일을 다운로드 받을수 있다.



- 4장에서는 그래픽스 파이프라인과 셰이더에서 일반적으로 사용하는 다양한 좌표 공간에 대해서 설명했다.
- 그리고 공간 사이를 변형하는 방법들에 대해서 이야기했다.
- 5장에서는 라이팅 셰이더로 향하는 여정을 기초부터 시작한다.