# 7장 서피스 셰이더

5장, 6장에선 



### [서피스 셰이더는 무엇인가?](#서피스 셰이더는 무엇인가?)

### [서피스 셰이더 편집](#서피스 셰이더 편집)

### [커스텀 라이팅 모델 작성](#커스텀 라이팅 모델 작성)

### [요약](#요약)



## 서피스 셰이더는 무엇인가?

라이팅 모델을 계산하는 특수한 유니티 셰이더 종류중 하나.

7장에선 오직 서피스 셰이더만 사용.

서피스 셰이더 장점 : 상당한 양의 보일러플레이트 코드 감춤

예 : 이전 장에서 멀티 광원 지원한다고 중복 코드 작성해야했음. 이렇게 추가작성을 피함

단점 : 약간의 코드 탄력성 감소

정교한 ForwardBase 패스 컨트롤 위해 언릿 셰이더 사용해야할수 있음.



서피스 셰이더 구조는 언릿 셰이더 구조와 다름.

언릿 셰이더는 두 가지 셰이더 함수(정점, 프레그먼트), 두 가지 데이터 구조체(정점 함수입력, 출력) 사용.

추가로 하나 이상 광원 사용시 ForwardBase, ForwardAdd라는 두 가지 패스 사용해야 했음.



서피스 셰이더에서 정점 함수는 필수가 아님.

두 가지 데이터의 구체적 사용 목적이 다름.

프레그먼트 유지

서피스 함수 작성 필요.

추가로 라이팅 모델 함수 작성할수도 있음.



### 기본 서피스 셰이더

프로젝트 창에서 마우스 우클릭 - Create - Shader - Standard - Surface Shader 선택해 신규 서피스 셰이더 생성한다.

[defaultSurfaceShader / 기본 서피스 셰이더 예시]



### Pragmas

### 신규 데이터 구조체

### 서피스 함수

### 라이팅 모델이란?

### 서피스 셰이더의 데이터 흐름



## 서피스 셰이더 편집

서피스 셰이더가 무엇인지, 어떠한 장점이 있는지 배웠다. 이제 유니티 표준 라이팅 함수를 사용하는 몇 가지 커스텀 셰이더를 살펴보자. 표준 라이팅 모델은 물리 기반이다.

[SurfaceShaderSecondAlbedo / 두 알베도 텍스처를 선영 보간한 서피스 셰이더]



### 두 번째 알베도 맵 추가하기

### 노멀 맵 추가하기

다른 작업 중 하나는 노멀 맵을 다루는 것이다.

7장 초반에 나왔던 기본 셰이더에 노멀 맵을 추가해보자.

[SurfaceShaderNormalMap / 노멀 맵을 추가한 최종 커스텀 서피스 셰이더]



### 그림자 작동 확인하기

모든 셰이더에 언급한적 없는 fallback값이 있다.

fallback : 메시 그림자 렌더링에 사용하는 다른 셰이더의 이름.

폴백 셰이더 존재하지 않거나 문제 있으면 메시 셰이더에도 문제 발생한다.

일부 메시 그림자 소실시 1순위 확인대상



### 다른 내장 라이팅 모델 사용

지금까지 표준 라이팅 모델을 사용했다.

라이팅을 개발자가 원하는 모델로 변경 가능하다.

표준 모델 대신 BlinnPhong을 사용해본다.

[SurfaceShaderBlinnPhong / 최종 BlinnPhong]



## 커스텀 라이팅 모델 작성

지금부터 라이팅 함수 작성에 대해 집중한다.

유니티에는 내장 Phong 라이팅 모델이 없고 대신 BlinnPhong을 사용한다.

Phong을 통해 배운 기존 지식을 활용해 커스텀 라이팅 모델을 구현해본다.



### 라이팅 모델 함수 시그니처

커스텀 라이팅 모델 함수가 가질 수 있는 시그니처 형태는 4가지로 제한적이다.

그중 둘은 포워드 렌더러에서 사용한다.

하나는 디퓨즈만 사용한다.

다른 하나는 뷰에 종속적, 즉 스펙큘러에서 사용할 수 있다.



- 디퓨즈용 시그니처

```C#
half4 Lighting<Name> (Surfaceoutput s, UnityGI gi);
```

- 뷰 종속 관련 시그니처

```C#
half4 Lighting<Name> (Surfaceoutput s, half3 viewDir, UnityGI gi);
```

- 나머지 두 가지 시그니처는 구버전, 최신버전 디퍼드 렌더러

디퍼드 렌더러는 다루지 않을 예정 -> 셰이더에서 사용할 수 있는 데이터를 제한하기 때문

학습하는 셰이더의 원리들은 디퍼드 렌더러에 적용되어있으니 나중에 참고

- 디퍼드 렌더러에서 사용하는 두 가지 시그니처

```
half4 Lighting<Name> _Deferred (SurfaceOutput s, UnityGI gi, out half4
outDiffuseOcclusion, out half4 outSpecSmoothness, out half4 outNormal);
half4 Lighting<Name> _PrePass (SurfaceOutput s, half4 light);
```



### SurfaceOutput 데이터 구조체

Phong 셰이더는 뷰에 종속적이다

따라서 두 번째 타입의 시그니처를 사용해야 한다.

[SurfaceShaderCustomPhong / 퐁 커스텀 라이팅 모델 함수를 추가한 셰이더

- 아래의 서피스 함수, 속성 블록, 커스텀 라이팅 함수의 내용 추가중]



### 서피스 함수

### 속성 블록

### 커스텀 라이팅 함수



## 요약

7장에서는 서피스 셰이더에 대해 알아보고 서피스 세이더의 장점에 대해 알아봤다.

이 장에서 가장 중요한 점은 커스텀 라이팅 모델 함수의 설명에 관한 부분이다.

언릿 세이더로 구현한 퐁을 서피스 셰이더의 커스텀 라이팅 함수로 변환하는 방법을 보여줬다.

다음으로 물리 기반 원리를 파헤쳐 보고 해당 내용을 자세히 설명한다.